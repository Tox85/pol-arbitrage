---
alwaysApply: true
---

# PolymMM-GuardedSpread - RÃ¨gle d'implÃ©mentation

## ğŸ“‹ Vue d'ensemble

Ce projet implÃ©mente un bot de market-making pour Polymarket suivant le flux **PolymMM-GuardedSpread v2**.

**Principe** : Trading sÃ©quentiel strict avec filtrage rigoureux, gestion des risques avancÃ©e, et retrait immÃ©diat si critÃ¨res non respectÃ©s.

## ğŸ¯ Architecture obligatoire

```
src/
â”œâ”€â”€ clients/          # Communication Polymarket
â”‚   â”œâ”€â”€ polySDK.ts    # SDK officiel wrapper
â”‚   â””â”€â”€ gamma.ts      # API Gamma (marchÃ©s)
â”œâ”€â”€ ws/               # WebSocket temps rÃ©el
â”‚   â”œâ”€â”€ marketFeed.ts # Prix (best bid/ask)
â”‚   â””â”€â”€ userFeed.ts   # Fills & order updates
â”œâ”€â”€ lib/              # Utilitaires
â”‚   â””â”€â”€ amounts.ts    # Quantisation montants
â”œâ”€â”€ data/             # DonnÃ©es marchÃ©
â”‚   â””â”€â”€ book.ts       # Orderbook
â”œâ”€â”€ core/             # Modules principaux
â”‚   â”œâ”€â”€ MarketSelector.ts  # Filtrage strict
â”‚   â”œâ”€â”€ StateMachine.ts    # Machine Ã  Ã©tats
â”‚   â”œâ”€â”€ RiskManager.ts     # Caps & exposition
â”‚   â”œâ”€â”€ OrderManager.ts    # Gestion ordres
â”‚   â””â”€â”€ MarketMaker.ts     # Orchestrateur
â”œâ”€â”€ config.ts         # Configuration
â””â”€â”€ index.ts          # Point d'entrÃ©e
```

## âš™ï¸ Variables de configuration (.env)

### Credentials (requis)
- PRIVATE_KEY
- CLOB_API_KEY
- CLOB_API_SECRET
- CLOB_PASSPHRASE
- POLY_PROXY_ADDRESS

### SÃ©lection des marchÃ©s
- MAX_MARKETS = 3
- MIN_SPREAD_CENTS = 1.5
- MIN_VOLUME_24H_USD = 5000
- MIN_DEPTH_TOP2_USD = 300
- HOURS_TO_CLOSE_MIN = 24
- MAX_MARKETS_PER_EVENT = 1

### Sizing & profitabilitÃ©
- MIN_NOTIONAL_PER_ORDER_USDC = 2.0
- MIN_EXPECTED_PROFIT_USDC = 0.02

### Caps de risque
- MAX_SHARES_PER_MARKET = 50
- MAX_USDC_PER_MARKET = 8
- MAX_NOTIONAL_AT_RISK_USDC = 25

### Gestion des ordres
- ORDER_TTL_MS = 10000
- REPLACE_PRICE_TICKS = 1
- ASK_CHASE_WINDOW_SEC = 8
- ASK_CHASE_MAX_REPLACES = 3

## ğŸ”„ Flux sÃ©quentiel (Machine Ã  Ã©tats)

### Ã‰tats obligatoires

IDLE â†’ PLACE_BUY â†’ WAIT_BUY_FILL â†’ PLACE_SELL â†’ ASK_CHASE â†’ WAIT_SELL_FILL â†’ COMPLETE â†’ IDLE
  â†³ DEACTIVATING (si critÃ¨res non respectÃ©s)

### DÃ©tail des Ã©tats

**IDLE** : MarchÃ© prÃªt pour nouveau cycle
- VÃ©rifier critÃ¨res Ã©ligibilitÃ©
- Transition vers PLACE_BUY si OK

**PLACE_BUY** : Placer ordre BUY
- Prix = best bid (arrondi tick)
- Taille = selon caps + min notional + expected profit
- Post-only : si croise â†’ +1 tick
- Type = GTC

**WAIT_BUY_FILL** : Attendre fill BUY
- Replace si best bid change â‰¥ REPLACE_PRICE_TICKS
- Replace si TTL expirÃ©
- Sur fill â†’ PLACE_SELL

**PLACE_SELL** : Placer ordre SELL
- Prix = best ask (arrondi tick)
- Taille = quantitÃ© achetÃ©e (miroir)
- Type = GTC
- Place mÃªme si spread tombÃ©

**ASK_CHASE** : Chase le ask
- FenÃªtre = ASK_CHASE_WINDOW_SEC (8s)
- Max replaces = ASK_CHASE_MAX_REPLACES (3)
- Replace si best ask change
- Ne jamais croiser bid

**WAIT_SELL_FILL** : Attendre fill SELL
- Sur fill â†’ COMPLETE

**COMPLETE** : Cycle terminÃ©
- Retour Ã  IDLE

**DEACTIVATING** : Retrait marchÃ©
- Si position > 0 : SELL + ask_chase jusqu'Ã  flat
- Si flat : annuler ordres + unsubscribe WS
- Remplacer par meilleur candidat

## ğŸ”’ Filtrage strict (MarketSelector)

Un marchÃ© est Ã©ligible SI ET SEULEMENT SI :

1. spread â‰¥ MIN_SPREAD_CENTS
2. volume_24h â‰¥ MIN_VOLUME_24H_USD
3. depth_top2 â‰¥ MIN_DEPTH_TOP2_USD
4. hours_to_close â‰¥ HOURS_TO_CLOSE_MIN
5. Supporte MIN_NOTIONAL_PER_ORDER_USDC
6. expected_profit = (spread/100) * notional â‰¥ MIN_EXPECTED_PROFIT_USDC

Score classement = spread*0.4 + depth*0.3 + volume*0.2 + time*0.1

SÃ©lectionner TOP 3 avec MAX_MARKETS_PER_EVENT = 1

## ğŸ›¡ï¸ Gouvernance des ordres

### Side-lock STRICT
- UN SEUL ordre actif par marchÃ© (BUY OU SELL)
- Pas de YES & NO simultanÃ©s

### Caps contraignants (RiskManager)

Refuser ordre si :
- position_shares_by_market > MAX_SHARES_PER_MARKET
- notional_exposure_by_market > MAX_USDC_PER_MARKET
- notional_exposure_global > MAX_NOTIONAL_AT_RISK_USDC
- taille_en_USDC < MIN_NOTIONAL_PER_ORDER_USDC
- expected_profit < MIN_EXPECTED_PROFIT_USDC

## ğŸ”„ Retrait immÃ©diat

Si marchÃ© actif ne respecte plus UN SEUL filtre :
1. ArrÃªter nouveaux BUY
2. Liquider position : SELL au best ask + ask_chase
3. Annuler ordres restants
4. Unsubscribe WebSocket
5. Remplacer par meilleur candidat

## ğŸ“Š Ingestion des donnÃ©es

### REST API (30-60s)
- GET /markets â†’ token_id, end_date
- POST /prices â†’ best bid/ask
- GET /spreads â†’ spread
- GET /book â†’ depth_top2

### WebSocket temps rÃ©el
- Market feed : best_bid/best_ask change
- User feed : ack, fill, cancel

### RÃ©conciliation (30-60s)
- GET /orders â†’ ordres ouverts
- Data API â†’ holdings/trades

## ğŸ”„ Remplacements & rÃ©activitÃ©

Replace BUY/SELL si :
- Best bid/ask bouge â‰¥ REPLACE_PRICE_TICKS
- TTL expirÃ© (ORDER_TTL_MS)
- Tick size change (WS)

Contrainte : UN SEUL ordre actif par marchÃ©

## ğŸ“ˆ Monitoring & invariants

### Invariants continus
- open_orders_by_market â‰¤ 1
- position_by_market â‰¤ MAX_SHARES_PER_MARKET
- notional_global â‰¤ MAX_NOTIONAL_AT_RISK_USDC
- Respect side-lock & caps

### Logs dÃ©taillÃ©s (skip_reasons)
- spread_too_small
- volume_low
- depth_low
- closing_soon
- min_notional
- expected_profit_low
- risk_cap_hit
- would_cross

### WebSocket santÃ©
- Ping/pong automatique
- Resubscribe automatique
- DÃ©tection inactifs (>5min)

## ğŸš« INTERDIT

- Placer YES et NO simultanÃ©ment sur mÃªme marchÃ©
- Plusieurs ordres actifs sur mÃªme marchÃ©
- DÃ©passer les caps (shares, notional, global)
- Ordres < MIN_NOTIONAL_PER_ORDER_USDC
- Expected profit < MIN_EXPECTED_PROFIT_USDC
- Trader marchÃ©s ne respectant pas filtres
- Code mort ou fichiers inutilisÃ©s

## âœ… Principes de dÃ©veloppement

1. SimplicitÃ© : Architecture claire, modules sÃ©parÃ©s
2. SÃ©curitÃ© : Caps stricts, invariants vÃ©rifiÃ©s
3. Robustesse : Retry, backoff, reconciliation
4. Monitoring : Logs dÃ©taillÃ©s, mÃ©triques
5. Performance : WebSocket temps rÃ©el
6. Clean code : Pas de code mort

## ğŸ¯ Objectif

Bot market-making rentable, sÃ©curisÃ© et robuste qui :
- Capture le spread sur marchÃ©s liquides
- GÃ¨re les risques strictement
- Se retire si conditions dÃ©favorables
- Monitore en continu
- Ne plante jamais

Version : PolymMM-GuardedSpread v2
